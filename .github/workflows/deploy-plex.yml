name: Deploy Maagverkleiningvitaminen (Plesk Static)

on:
  push:
    branches:
      - codex/maagverkleiningvitaminen
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/codex/maagverkleiningvitaminen'
    env:
      DEPLOY_METHOD: ${{ secrets.MV_DEPLOY_METHOD }}
      DEPLOY_HOST: ${{ secrets.MV_DEPLOY_HOST }}
      DEPLOY_USER: ${{ secrets.MV_DEPLOY_USER }}
      DEPLOY_PORT: ${{ secrets.MV_DEPLOY_PORT }}
      DEPLOY_PATH: ${{ secrets.MV_DEPLOY_PATH }}
      FTP_HOST: ${{ secrets.MV_FTP_HOST }}
      FTP_USER: ${{ secrets.MV_FTP_USER }}
      FTP_PASS: ${{ secrets.MV_FTP_PASS }}
      FTP_PORT: ${{ secrets.MV_FTP_PORT }}
      FTP_PATH: ${{ secrets.MV_FTP_PATH }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate static source
        run: |
          if [[ ! -f "wls-static/index.html" ]]; then
            echo "::error::wls-static/index.html ontbreekt."
            exit 1
          fi

      - name: Select deploy method
        id: select_method
        run: |
          method="$(printf '%s' "${DEPLOY_METHOD:-}" | tr '[:upper:]' '[:lower:]' | xargs)"
          if [[ -z "$method" ]]; then
            method="ftp"
          fi
          if [[ "$method" != "ssh" && "$method" != "ftp" ]]; then
            echo "::error::MV_DEPLOY_METHOD moet 'ssh' of 'ftp' zijn."
            exit 1
          fi
          echo "method=$method" >> "$GITHUB_OUTPUT"
          echo "Deploy method: $method"

      - name: Show deploy inputs (safe)
        run: |
          echo "method=${{ steps.select_method.outputs.method }}"
          [[ -n "${FTP_HOST//[[:space:]]/}" ]] && echo "FTP_HOST: set" || echo "FTP_HOST: missing"
          [[ -n "${FTP_USER//[[:space:]]/}" ]] && echo "FTP_USER: set" || echo "FTP_USER: missing"
          [[ -n "${FTP_PASS//[[:space:]]/}" ]] && echo "FTP_PASS: set" || echo "FTP_PASS: missing"
          [[ -n "${FTP_PATH//[[:space:]]/}" ]] && echo "FTP_PATH: set" || echo "FTP_PATH: missing"

      - name: Setup SSH key
        if: steps.select_method.outputs.method == 'ssh'
        env:
          DEPLOY_KEY: ${{ secrets.MV_DEPLOY_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          if [[ -z "${DEPLOY_KEY//[[:space:]]/}" ]]; then
            echo "::error::Secret MV_DEPLOY_SSH_KEY is leeg of ontbreekt."
            exit 1
          fi
          if echo "$DEPLOY_KEY" | grep -q "BEGIN .* PRIVATE KEY"; then
            printf '%s\n' "$DEPLOY_KEY" > ~/.ssh/deploy_key
          else
            if ! printf '%s' "$DEPLOY_KEY" | base64 --decode > ~/.ssh/deploy_key 2>/tmp/keydecode.err; then
              echo "::error::MV_DEPLOY_SSH_KEY is geen geldige private key (raw of base64)."
              cat /tmp/keydecode.err
              exit 1
            fi
          fi
          tr -d '\r' < ~/.ssh/deploy_key > ~/.ssh/deploy_key.clean
          mv ~/.ssh/deploy_key.clean ~/.ssh/deploy_key
          if grep -Eq '^(ssh-rsa|ssh-ed25519|ecdsa-sha2-nistp)' ~/.ssh/deploy_key; then
            echo "::error::MV_DEPLOY_SSH_KEY lijkt een publieke key. Gebruik de private key met BEGIN/END PRIVATE KEY."
            exit 1
          fi
          chmod 600 ~/.ssh/deploy_key
          if ! ssh-keygen -y -f ~/.ssh/deploy_key >/dev/null 2>/tmp/keycheck.err; then
            echo "::error::Private key formaat ongeldig of niet leesbaar door ssh-keygen."
            cat /tmp/keycheck.err
            exit 1
          fi

      - name: Add host key
        if: steps.select_method.outputs.method == 'ssh'
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          PORT="${DEPLOY_PORT:-22}"
          if ! timeout 20 ssh-keyscan -T 10 -p "$PORT" "$DEPLOY_HOST" >> ~/.ssh/known_hosts 2>/tmp/sshscan.err; then
            echo "::error::Kan SSH host key niet ophalen van ${DEPLOY_HOST}:${PORT}. Controleer SSH toegang/poort/firewall in Plesk."
            cat /tmp/sshscan.err || true
            exit 1
          fi

      - name: Verify SSH login
        if: steps.select_method.outputs.method == 'ssh'
        run: |
          set -euo pipefail
          PORT="${DEPLOY_PORT:-22}"
          if ! ssh -i ~/.ssh/deploy_key -p "$PORT" -o BatchMode=yes -o ConnectTimeout=12 "$DEPLOY_USER@$DEPLOY_HOST" "echo SSH_OK" >/tmp/sshlogin.out 2>/tmp/sshlogin.err; then
            echo "::error::SSH login mislukt naar ${DEPLOY_USER}@${DEPLOY_HOST}:${PORT}. Controleer user, poort en of SSH voor deze user aan staat."
            cat /tmp/sshlogin.err || true
            exit 1
          fi
          cat /tmp/sshlogin.out

      - name: Ensure target path exists
        if: steps.select_method.outputs.method == 'ssh'
        run: |
          if [[ -z "${DEPLOY_PATH//[[:space:]]/}" ]]; then
            echo "::error::Secret MV_DEPLOY_PATH is leeg of ontbreekt."
            exit 1
          fi
          PORT="${DEPLOY_PORT:-22}"
          ssh -i ~/.ssh/deploy_key -p "$PORT" "$DEPLOY_USER@$DEPLOY_HOST" "mkdir -p '$DEPLOY_PATH'"

      - name: Sync static site to server
        if: steps.select_method.outputs.method == 'ssh'
        run: |
          PORT="${DEPLOY_PORT:-22}"
          rsync -az --delete \
            -e "ssh -i ~/.ssh/deploy_key -p $PORT" \
            ./wls-static/ "$DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/"

      - name: Install lftp
        if: steps.select_method.outputs.method == 'ftp'
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

      - name: Validate FTP secrets
        if: steps.select_method.outputs.method == 'ftp'
        run: |
          if [[ -z "${FTP_HOST//[[:space:]]/}" || -z "${FTP_USER//[[:space:]]/}" || -z "${FTP_PASS//[[:space:]]/}" ]]; then
            echo "::error::FTP secrets ontbreken. Zet MV_FTP_HOST, MV_FTP_USER en MV_FTP_PASS."
            exit 1
          fi
          if [[ -z "${FTP_PATH//[[:space:]]/}" ]]; then
            echo "::error::Secret MV_FTP_PATH ontbreekt (bijv. httpdocs)."
            exit 1
          fi

      - name: Sync static site via FTP/FTPS
        if: steps.select_method.outputs.method == 'ftp'
        run: |
          PORT="${FTP_PORT:-21}"
          lftp -e "
          set cmd:fail-exit yes;
          set ftp:ssl-allow yes;
          set ssl:verify-certificate no;
          open -u \"$FTP_USER\",\"$FTP_PASS\" -p \"$PORT\" \"$FTP_HOST\";
          mkdir -p \"$FTP_PATH\";
          mirror -R --delete --verbose ./wls-static \"$FTP_PATH\";
          bye
          "
